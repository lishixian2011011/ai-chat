/**
 * ============================================================================
 * æ–‡ä»¶ä¸Šä¼  API (app/api/upload/route.js)
 * ============================================================================
 * 
 * æ–‡ä»¶ä½œç”¨ï¼š
 *   å¤„ç†æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†å›¾ç‰‡ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°ç›®å½•
 * 
 * ä¸»è¦åŠŸèƒ½ï¼š
 *   1. æ¥æ”¶ FormData æ ¼å¼çš„æ–‡ä»¶
 *   2. éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
 *   3. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åå¹¶ä¿å­˜åˆ°æœ¬åœ°
 *   4. è¿”å›æ–‡ä»¶çš„å®Œæ•´è®¿é—® URL
 * 
 * è·¯ç”±ï¼šPOST /api/upload
 * 
 * å­˜å‚¨è·¯å¾„ï¼š
 *   public/uploads/images/{å¹´ä»½}/{æœˆä»½}/{æ—¶é—´æˆ³}_{éšæœºå­—ç¬¦ä¸²}.{æ‰©å±•å}
 *   ä¾‹å¦‚ï¼špublic/uploads/images/2024/01/1704067200000_abc123.jpg
 * 
 * è®¿é—® URLï¼š
 *   http://localhost:3000/uploads/images/2024/01/1704067200000_abc123.jpg
 * 
 * ============================================================================
 */
import { mkdir, writeFile, access } from 'fs/promises'; //  ä½¿ç”¨ ES modules
import { existsSync, statSync } from 'fs';              //  å¯¼å…¥åŒæ­¥æ–¹æ³•
import { join } from 'path';                    // è·¯å¾„æ‹¼æ¥å·¥å…·
import { NextResponse } from 'next/server';
import log from '@/lib/log';

/**
 * POST - æ–‡ä»¶ä¸Šä¼ æ¥å£
 * 
 * è¯·æ±‚æ ¼å¼ï¼šmultipart/form-data
 * è¯·æ±‚ä½“ï¼š
 *   - file: Fileï¼ˆæ–‡ä»¶å¯¹è±¡ï¼‰
 * 
 * é™åˆ¶ï¼š
 *   - æ–‡ä»¶å¤§å°ï¼šæœ€å¤§ 10MB
 *   - æ–‡ä»¶ç±»å‹ï¼šåªæ”¯æŒå›¾ç‰‡ï¼ˆimage/*ï¼‰
 * 
 * å“åº”ï¼š
 *   {
 *     success: true,
 *     data: {
 *       url: string,       // å®Œæ•´è®¿é—® URL
 *       filename: string,  // åŸå§‹æ–‡ä»¶å
 *       size: number,      // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
 *       mimeType: string   // MIME ç±»å‹
 *     }
 *   }
 */
export async function POST(req) {
  try {
    // ========================================================================
    // 1. è§£æ FormData å¹¶è·å–æ–‡ä»¶
    // ========================================================================
    const formData = await req.formData();
    const file = formData.get('file');  // è·å–åä¸º 'file' çš„å­—æ®µ
    
    if (!file) {
      return NextResponse.json(
        { error: 'æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶' },
        { status: 400 }  // 400 Bad Request
      );
    }

    // ========================================================================
    // 2. éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§ 10MBï¼‰
    // ========================================================================
    if (file.size > 10 * 1024 * 1024) {
      return NextResponse.json(
        { error: 'æ–‡ä»¶å¤§å°è¶…è¿‡ 10MB é™åˆ¶' },
        { status: 400 }
      );
    }

    // ========================================================================
    // 3. éªŒè¯æ–‡ä»¶ç±»å‹ï¼ˆåªå…è®¸å›¾ç‰‡ï¼‰
    // ========================================================================
    if (!file.type.startsWith('image/')) {
      return NextResponse.json(
        { error: 'åªæ”¯æŒå›¾ç‰‡æ–‡ä»¶' },
        { status: 400 }
      );
    }

    // ========================================================================
    // 4. è¯»å–æ–‡ä»¶å†…å®¹
    // ========================================================================
    const bytes = await file.arrayBuffer();  // è¯»å–ä¸º ArrayBuffer
    const buffer = Buffer.from(bytes);       // è½¬æ¢ä¸º Node.js Buffer

    // ========================================================================
    // 5. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
    // ========================================================================
    const timestamp = Date.now();                              // æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    const randomString = Math.random().toString(36).substring(7);  // éšæœºå­—ç¬¦ä¸²ï¼ˆ7ä½ï¼‰
    const ext = file.name.split('.').pop();                    // æ–‡ä»¶æ‰©å±•å
    const filename = `${timestamp}_${randomString}.${ext}`;    // æœ€ç»ˆæ–‡ä»¶å
    // ç¤ºä¾‹ï¼š1704067200000_abc123.jpg

    // ========================================================================
    // 6. åˆ›å»ºç›®å½•ç»“æ„ï¼ˆæŒ‰å¹´æœˆåˆ†ç±»ï¼‰
    // ========================================================================
    const year = new Date().getFullYear();                     // å¹´ä»½ï¼ˆå¦‚ï¼š2024ï¼‰
    const month = String(new Date().getMonth() + 1).padStart(2, '0');  // æœˆä»½ï¼ˆå¦‚ï¼š01ï¼‰
    const uploadDir = join(
      process.cwd(),           // é¡¹ç›®æ ¹ç›®å½•
      'public',                // public ç›®å½•
      'uploads',               // uploads ç›®å½•
      'images',                // images ç›®å½•
      String(year),            // å¹´ä»½ç›®å½•
      month                    // æœˆä»½ç›®å½•
    );
    // ç¤ºä¾‹ï¼š/path/to/project/public/uploads/images/2024/01
    //  è°ƒè¯•æ—¥å¿—
    log.debug('ğŸ“ ä¸Šä¼ ç›®å½•:', uploadDir);
    log.debug('ğŸ“ å½“å‰å·¥ä½œç›®å½•:', process.cwd());
    
    // ç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆé€’å½’åˆ›å»ºï¼‰
    await mkdir(uploadDir, { recursive: true });
    
    // ========================================================================
    // 7. ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜
    // ========================================================================
    const filepath = join(uploadDir, filename);  // å®Œæ•´æ–‡ä»¶è·¯å¾„
    log.debug('ğŸ“ æ–‡ä»¶è·¯å¾„:', filepath);
    await writeFile(filepath, buffer);           // å†™å…¥æ–‡ä»¶
    //  éªŒè¯æ–‡ä»¶æ˜¯å¦çœŸçš„ä¿å­˜äº†ï¼ˆä½¿ç”¨åŒæ­¥æ–¹æ³•ï¼‰
    const exists = existsSync(filepath);
    log.debug(' æ–‡ä»¶æ˜¯å¦å­˜åœ¨:', exists);
    
    if (exists) {
      //  æ£€æŸ¥ç›®å½•æƒé™
      const stats = statSync(uploadDir);
      log.debug('ğŸ“Š ç›®å½•æƒé™:', stats.mode.toString(8));
      log.debug('ğŸ“Š æ–‡ä»¶å¤§å°:', statSync(filepath).size, 'bytes');
    } else {
      console.error('âŒ æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨');
    }


    // ========================================================================
    // 8. ç”Ÿæˆè®¿é—® URL
    // ========================================================================
    // ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº public ç›®å½•ï¼‰
    // ç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡ API è·¯ç”±è®¿é—®ï¼‰
    const url = `/api/files/uploads/images/${year}/${month}/${filename}`;
    //const url = `/uploads/images/${year}/${month}/${filename}`;
    
    // å®Œæ•´ URLï¼ˆåŒ…å«åŸŸåï¼‰
    const baseUrl = process.env.NEXTAUTH_URL || 'http://localhost:3000';
    const fullUrl = `${baseUrl}${url}`;
    // ç¤ºä¾‹ï¼šhttp://localhost:3000/uploads/images/2024/01/1704067200000_abc123.jpg

    // ========================================================================
    // 9. è¿”å›æˆåŠŸå“åº”
    // ========================================================================
    return NextResponse.json({
      success: true,
      data: {
        url: fullUrl,          // å®Œæ•´è®¿é—® URL
        filename: file.name,   // åŸå§‹æ–‡ä»¶å
        size: file.size,       // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        mimeType: file.type    // MIME ç±»å‹ï¼ˆå¦‚ï¼šimage/jpegï¼‰
      }
    });
  } catch (error) {
    // ========================================================================
    // é”™è¯¯å¤„ç†
    // ========================================================================
    console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
    return NextResponse.json(
      { error: 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥' },
      { status: 500 }  // 500 Internal Server Error
    );
  }
}
