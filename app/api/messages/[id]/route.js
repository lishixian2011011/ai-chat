/**
 * ============================================================================
 * æ¶ˆæ¯æ“ä½œ API (app/api/messages/[id]/route.js)
 * ============================================================================
 * 
 * æ–‡ä»¶ä½œç”¨ï¼š
 *   å¤„ç†å•ä¸ªæ¶ˆæ¯çš„æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œ
 * 
 * ä¸»è¦åŠŸèƒ½ï¼š
 *   1. GETï¼šè·å–å•æ¡æ¶ˆæ¯ï¼ˆ æ–°å¢ï¼ŒåŒ…å« citationsï¼‰
 *   2. PATCHï¼šæ›´æ–°æ¶ˆæ¯å†…å®¹ï¼ˆ æ”¯æŒæ›´æ–°å¼•ç”¨æ¥æºå’Œè”ç½‘æœç´¢æ ‡è¯†ï¼‰
 *   3. DELETEï¼šåˆ é™¤æ¶ˆæ¯
 * 
 * è·¯ç”±ï¼š
 *   - GET /api/messages/:id      æ–°å¢
 *   - PATCH /api/messages/:id
 *   - DELETE /api/messages/:id
 * 
 * æƒé™éªŒè¯ï¼š
 *   - éœ€è¦ç™»å½•
 *   - åªèƒ½æ“ä½œè‡ªå·±ä¼šè¯ä¸­çš„æ¶ˆæ¯ï¼ˆé€šè¿‡ conversation.userId éªŒè¯ï¼‰
 * 
 * ä¿®æ”¹è®°å½•ï¼š
 *   - 2025-11-15ï¼šæ·»åŠ  GET æ–¹æ³•ï¼ˆè·å–å•æ¡æ¶ˆæ¯ï¼‰
 *   - æ”¯æŒè·å–æ¶ˆæ¯çš„å®Œæ•´ citations æ•°æ®
 * 
 * ============================================================================
 */

import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { auth } from '@/app/api/auth/[...nextauth]/route';

/**
 * ============================================================================
 * GET - è·å–å•æ¡æ¶ˆæ¯ï¼ˆ æ–°å¢ï¼‰
 * ============================================================================
 * 
 * åŠŸèƒ½ï¼š
 *   - è·å–æŒ‡å®šæ¶ˆæ¯çš„å®Œæ•´ä¿¡æ¯
 *   - åŒ…å«å¼•ç”¨æ¥æºï¼ˆcitationsï¼‰
 *   - éªŒè¯ç”¨æˆ·æƒé™
 * 
 * ä½¿ç”¨åœºæ™¯ï¼š
 *   1. æµå¼è¾“å‡ºå®Œæˆåï¼Œåˆ·æ–°æ¶ˆæ¯ä»¥è·å–å®Œæ•´çš„ citations
 *   2. å‰ç«¯éœ€è¦é‡æ–°åŠ è½½å•æ¡æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯
 *   3. ç¡®ä¿ citations æ•°æ®å®Œæ•´æ€§
 * 
 * è·¯ç”±å‚æ•°ï¼š
 *   - id: string  // æ¶ˆæ¯ IDï¼ˆä» URL è·¯å¾„è·å–ï¼‰
 * 
 * å“åº”ï¼š
 *   {
 *     success: true,
 *     data: {
 *       id: string,
 *       conversationId: string,
 *       role: 'user' | 'assistant',
 *       content: string,
 *       tokensUsed: number,
 *       isWebSearch: boolean,
 *       citations: Array,        //  å¼•ç”¨æ¥æºæ•°ç»„
 *       createdAt: Date,
 *       updatedAt: Date
 *     }
 *   }
 * 
 * é”™è¯¯ç ï¼š
 *   - 401: æœªç™»å½•
 *   - 403: æ— æƒé™è®¿é—®æ­¤æ¶ˆæ¯
 *   - 404: æ¶ˆæ¯ä¸å­˜åœ¨
 *   - 500: æœåŠ¡å™¨é”™è¯¯
 */
export async function GET(req, { params }) {
  try {
    // ========================================================================
    // 1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
    // ========================================================================
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json(
        { success: false, error: 'æœªæˆæƒ' },
        { status: 401 }
      );
    }

    // ========================================================================
    // 2. è·å–è·¯ç”±å‚æ•°
    // ========================================================================
    const { id: messageId } = await params;

    // ========================================================================
    // 3. ä»æ•°æ®åº“æŸ¥è¯¢æ¶ˆæ¯ï¼ˆåŒ…å«å…³è”çš„ä¼šè¯ä¿¡æ¯ï¼‰
    // ========================================================================
    const message = await prisma.message.findUnique({
      where: { id: messageId },
      include: {
        conversation: {
          select: { userId: true }  // åªæŸ¥è¯¢ userId ç”¨äºæƒé™éªŒè¯
        }
      }
    });

    // ========================================================================
    // 4. éªŒè¯æ¶ˆæ¯æ˜¯å¦å­˜åœ¨
    // ========================================================================
    if (!message) {
      return NextResponse.json(
        { success: false, error: 'æ¶ˆæ¯ä¸å­˜åœ¨' },
        { status: 404 }
      );
    }

    // ========================================================================
    // 5. éªŒè¯ç”¨æˆ·æƒé™ï¼ˆé˜²æ­¢è¶Šæƒè®¿é—®ï¼‰
    // ========================================================================
    if (message.conversation.userId !== session.user.id) {
      return NextResponse.json(
        { success: false, error: 'æ— æƒè®¿é—®æ­¤æ¶ˆæ¯' },
        { status: 403 }
      );
    }

    // ========================================================================
    // 6. è¿”å›æ¶ˆæ¯æ•°æ®ï¼ˆ åŒ…å« citationsï¼‰
    // ========================================================================
    const responseData = {
      id: message.id,
      conversationId: message.conversationId,
      role: message.role,
      content: message.content,
      tokensUsed: message.tokensUsed || 0,
      isWebSearch: message.isWebSearch || false,
      citations: message.citations || [],  //  å¼•ç”¨æ¥æº
      createdAt: message.createdAt,
      updatedAt: message.updatedAt
    };

    //  è°ƒè¯•æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
    if (process.env.NODE_ENV === 'development') {
      console.log(`ğŸ“¥ GET /api/messages/${messageId}:`, {
        role: responseData.role,
        isWebSearch: responseData.isWebSearch,
        citationsCount: responseData.citations?.length || 0
      });
    }

    return NextResponse.json({
      success: true,
      data: responseData
    });

  } catch (error) {
    console.error('âŒ è·å–æ¶ˆæ¯å¤±è´¥:', error);
    return NextResponse.json(
      { success: false, error: 'è·å–æ¶ˆæ¯å¤±è´¥' },
      { status: 500 }
    );
  }
}

/**
 * ============================================================================
 * PATCH - æ›´æ–°æ¶ˆæ¯å†…å®¹
 * ============================================================================
 * 
 * åŠŸèƒ½ï¼š
 *   - æ›´æ–°æŒ‡å®šæ¶ˆæ¯çš„å†…å®¹å’Œ token ä½¿ç”¨é‡
 *   -  æ”¯æŒï¼šæ›´æ–°å¼•ç”¨æ¥æºï¼ˆcitationsï¼‰
 *   -  æ”¯æŒï¼šæ›´æ–°è”ç½‘æœç´¢æ ‡è¯†ï¼ˆisWebSearchï¼‰
 *   - ä¸»è¦ç”¨äº AI æµå¼è¾“å‡ºå®Œæˆåï¼Œä¿å­˜å®Œæ•´çš„å›å¤å†…å®¹
 * 
 * ä½¿ç”¨åœºæ™¯ï¼š
 *   1. AI æµå¼è¾“å‡ºæ—¶ï¼Œå‰ç«¯å®æ—¶æ˜¾ç¤ºéƒ¨åˆ†å†…å®¹
 *   2. æµå¼è¾“å‡ºå®Œæˆåï¼Œè°ƒç”¨æ­¤æ¥å£ä¿å­˜å®Œæ•´å†…å®¹åˆ°æ•°æ®åº“
 *   3. æ›´æ–° token ä½¿ç”¨é‡ï¼ˆç”¨äºè®¡è´¹ç»Ÿè®¡ï¼‰
 *   4.  ä¿å­˜è”ç½‘æœç´¢çš„å¼•ç”¨æ¥æº
 * 
 * è·¯ç”±å‚æ•°ï¼š
 *   - id: string  // æ¶ˆæ¯ IDï¼ˆä» URL è·¯å¾„è·å–ï¼‰
 * 
 * è¯·æ±‚ä½“ï¼š
 *   {
 *     content: string,           // å®Œæ•´çš„æ¶ˆæ¯å†…å®¹
 *     tokensUsed?: number,       // token ä½¿ç”¨é‡ï¼ˆå¯é€‰ï¼‰
 *     citations?: Array,         //  å¼•ç”¨æ¥æºæ•°ç»„ï¼ˆå¯é€‰ï¼‰
 *     isWebSearch?: boolean      //  æ˜¯å¦ä¸ºè”ç½‘æœç´¢ï¼ˆå¯é€‰ï¼‰
 *   }
 * 
 * å“åº”ï¼š
 *   {
 *     success: true,
 *     data: {
 *       id: string,
 *       conversationId: string,
 *       role: 'user' | 'assistant',
 *       content: string,
 *       tokensUsed: number,
 *       citations: Array,        //  å¼•ç”¨æ¥æº
 *       isWebSearch: boolean,    //  è”ç½‘æœç´¢æ ‡è¯†
 *       createdAt: Date
 *     }
 *   }
 * 
 * é”™è¯¯ç ï¼š
 *   - 401: æœªç™»å½•
 *   - 403: æ— æƒé™æ“ä½œæ­¤æ¶ˆæ¯
 *   - 404: æ¶ˆæ¯ä¸å­˜åœ¨
 *   - 500: æœåŠ¡å™¨é”™è¯¯
 */
export async function PATCH(req, { params }) {
  try {
    // ========================================================================
    // 1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
    // ========================================================================
    const session = await auth();
    if (!session) {
      return NextResponse.json(
        { success: false, error: 'æœªç™»å½•' },
        { status: 401 }
      );
    }

    // ========================================================================
    // 2. è·å–è·¯ç”±å‚æ•°å’Œè¯·æ±‚ä½“
    // ========================================================================
    const { id: messageId } = await params;
    
    //  è§£æ„æ–°å¢çš„å­—æ®µ
    const { 
      content, 
      tokensUsed, 
      citations,      //  å¼•ç”¨æ¥æº
      isWebSearch     //  è”ç½‘æœç´¢æ ‡è¯†
    } = await req.json();

    // ========================================================================
    // 3. æŸ¥è¯¢æ¶ˆæ¯å¹¶éªŒè¯æ‰€æœ‰æƒ
    // ========================================================================
    const message = await prisma.message.findUnique({
      where: { id: messageId },
      include: {
        conversation: true
      }
    });

    // ========================================================================
    // 4. éªŒè¯æ¶ˆæ¯æ˜¯å¦å­˜åœ¨
    // ========================================================================
    if (!message) {
      return NextResponse.json(
        { success: false, error: 'æ¶ˆæ¯ä¸å­˜åœ¨' },
        { status: 404 }
      );
    }

    // ========================================================================
    // 5. éªŒè¯ç”¨æˆ·æƒé™ï¼ˆé˜²æ­¢è¶Šæƒè®¿é—®ï¼‰
    // ========================================================================
    if (message.conversation.userId !== session.user.id) {
      return NextResponse.json(
        { success: false, error: 'æ— æƒé™æ“ä½œæ­¤æ¶ˆæ¯' },
        { status: 403 }
      );
    }

    // ========================================================================
    // 6. æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼ˆ åŒ…å«æ–°å­—æ®µï¼‰
    // ========================================================================
    const updatedMessage = await prisma.message.update({
      where: { id: messageId },
      data: {
        content,
        // æ¡ä»¶æ›´æ–°ï¼šåªæœ‰ä¼ å…¥æ—¶æ‰æ›´æ–°
        ...(tokensUsed !== undefined && { tokensUsed }),
        //  æ¡ä»¶æ›´æ–°å¼•ç”¨æ¥æº
        ...(citations !== undefined && { citations }),
        //  æ¡ä»¶æ›´æ–°è”ç½‘æœç´¢æ ‡è¯†
        ...(isWebSearch !== undefined && { isWebSearch })
      }
    });

    //  æ—¥å¿—è®°å½•ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
    if (process.env.NODE_ENV === 'development') {
      console.log(` PATCH /api/messages/${messageId}:`, {
        contentLength: content?.length,
        citationsCount: citations?.length || 0,
        isWebSearch: isWebSearch || false
      });
    }

    // ========================================================================
    // 7. è¿”å›æ›´æ–°åçš„æ¶ˆæ¯
    // ========================================================================
    return NextResponse.json({
      success: true,
      data: updatedMessage
    });

  } catch (error) {
    console.error('âŒ æ›´æ–°æ¶ˆæ¯å¤±è´¥:', error);
    return NextResponse.json(
      { success: false, error: 'æ›´æ–°æ¶ˆæ¯å¤±è´¥' },
      { status: 500 }
    );
  }
}

/**
 * ============================================================================
 * DELETE - åˆ é™¤æ¶ˆæ¯
 * ============================================================================
 * 
 * åŠŸèƒ½ï¼š
 *   - åˆ é™¤æŒ‡å®šçš„æ¶ˆæ¯
 *   - éªŒè¯ç”¨æˆ·æƒé™ï¼ˆåªèƒ½åˆ é™¤è‡ªå·±ä¼šè¯ä¸­çš„æ¶ˆæ¯ï¼‰
 *   -  è‡ªåŠ¨åˆ é™¤å…³è”çš„å¼•ç”¨æ¥æºæ•°æ®ï¼ˆå¦‚æœ citations æ˜¯å…³è”è¡¨ï¼‰
 * 
 * ä½¿ç”¨åœºæ™¯ï¼š
 *   - ç”¨æˆ·æƒ³åˆ é™¤æŸæ¡é”™è¯¯çš„æ¶ˆæ¯
 *   - æ¸…ç†ä¼šè¯å†å²
 *   - æ’¤å›åˆšå‘é€çš„æ¶ˆæ¯
 * 
 * è·¯ç”±å‚æ•°ï¼š
 *   - id: string  // æ¶ˆæ¯ ID
 * 
 * å“åº”ï¼š
 *   {
 *     success: true,
 *     message: 'æ¶ˆæ¯å·²åˆ é™¤'
 *   }
 * 
 * é”™è¯¯ç ï¼š
 *   - 401: æœªç™»å½•
 *   - 403: æ— æƒé™æ“ä½œæ­¤æ¶ˆæ¯
 *   - 404: æ¶ˆæ¯ä¸å­˜åœ¨
 *   - 500: æœåŠ¡å™¨é”™è¯¯
 * 
 * âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
 *   - åˆ é™¤æ¶ˆæ¯ä¼šåŒæ—¶åˆ é™¤å…³è”çš„å¼•ç”¨æ¥æºï¼ˆcitations å­—æ®µï¼‰
 *   - åˆ é™¤æ¶ˆæ¯ä¸ä¼šåˆ é™¤å…³è”çš„ä¼šè¯
 *   - å¦‚æœåˆ é™¤æ‰€æœ‰æ¶ˆæ¯ï¼Œä¼šè¯ä»ç„¶å­˜åœ¨ï¼ˆå˜ä¸ºç©ºä¼šè¯ï¼‰
 */
export async function DELETE(req, { params }) {
  try {
    // ========================================================================
    // 1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
    // ========================================================================
    const session = await auth();
    if (!session) {
      return NextResponse.json(
        { success: false, error: 'æœªç™»å½•' },
        { status: 401 }
      );
    }

    // ========================================================================
    // 2. è·å–è·¯ç”±å‚æ•°
    // ========================================================================
    const { id: messageId } = await params;

    // ========================================================================
    // 3. æŸ¥è¯¢æ¶ˆæ¯å¹¶éªŒè¯æ‰€æœ‰æƒ
    // ========================================================================
    const message = await prisma.message.findUnique({
      where: { id: messageId },
      include: {
        conversation: true
      }
    });

    // ========================================================================
    // 4. éªŒè¯æ¶ˆæ¯æ˜¯å¦å­˜åœ¨
    // ========================================================================
    if (!message) {
      return NextResponse.json(
        { success: false, error: 'æ¶ˆæ¯ä¸å­˜åœ¨' },
        { status: 404 }
      );
    }

    // ========================================================================
    // 5. éªŒè¯ç”¨æˆ·æƒé™
    // ========================================================================
    if (message.conversation.userId !== session.user.id) {
      return NextResponse.json(
        { success: false, error: 'æ— æƒé™æ“ä½œæ­¤æ¶ˆæ¯' },
        { status: 403 }
      );
    }

    //  åˆ é™¤å‰è®°å½•æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
    if (process.env.NODE_ENV === 'development') {
      const citationsCount = message.citations?.length || 0;
      if (citationsCount > 0) {
        console.log(`âš ï¸ DELETE /api/messages/${messageId}: åŒ…å« ${citationsCount} ä¸ªå¼•ç”¨æ¥æº`);
      }
    }

    // ========================================================================
    // 6. åˆ é™¤æ¶ˆæ¯ï¼ˆ è‡ªåŠ¨åˆ é™¤å…³è”çš„ citations æ•°æ®ï¼‰
    // ========================================================================
    await prisma.message.delete({
      where: { id: messageId }
    });

    //  æ—¥å¿—è®°å½•ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
    if (process.env.NODE_ENV === 'development') {
      console.log(` DELETE /api/messages/${messageId}: æ¶ˆæ¯å·²åˆ é™¤`);
    }

    // ========================================================================
    // 7. è¿”å›æˆåŠŸå“åº”
    // ========================================================================
    return NextResponse.json({
      success: true,
      message: 'æ¶ˆæ¯å·²åˆ é™¤'
    });

  } catch (error) {
    console.error('âŒ åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
    return NextResponse.json(
      { success: false, error: 'åˆ é™¤æ¶ˆæ¯å¤±è´¥' },
      { status: 500 }
    );
  }
}
